name: selenium build and test
on:
  push:
  workflow_dispatch:
    inputs:
      environment:
          description: "The environment to deploy the releases to."
          required: true
          type: choice
          options:
            - dev
            
jobs: 
  build:
    runs-on: windows-latest
    environment:
      name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.env || 'dev' }}
    steps:
      - name: Validation
        shell: pwsh
        run: |

          Write-Host "vars.var: $vars.SETTINGS_BASE64_INVOLVE_TESTING_SELENIUM"
          Write-Host "vars.SETTINGS_BASE64_INVOLVE_TESTING_SELENIUM: ${{ vars.SETTINGS_BASE64_INVOLVE_TESTING_SELENIUM }}"
          
          $requiredVariables = @("SETTINGS_BASE64_INVOLVE_TESTING_SELENIUM")
          foreach ($var in $requiredVariables) {
            if (-not [System.Environment]::GetEnvironmentVariable($var)) {
              Write-Error "Missing required environment variable: $var"
            }
          }
          
          $requiredSecrets = @("DEPLOYMENT_AZURE_CLIENT_ID", "DEPLOYMENT_AZURE_CLIENT_SECRET", "DEPLOYMENT_AZURE_SUBSCRIPTION_ID", "DEPLOYMENT_AZURE_TENANT_ID")
          foreach ($secret in $requiredSecrets) {
            if (-not $secrets.$secret) {
              Write-Error "Missing required environment secret: $secret"
            }
          }
    
      - name: Set solution variable
        shell: pwsh
        run: |
          echo "SOLUTION=src/TestSolution/TestSolution.slnx" >> $env:GITHUB_ENV
          echo "SOLUTION_DIR=src/TestSolution" >> $env:GITHUB_ENV
         
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Setup NuGet to be used with Actions
        uses: NuGet/setup-nuget@v2.0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        
      - name: Restore the NuGet packages
        run: nuget restore $env:SOLUTION
      
      - name: Build the solution
        run: msbuild $env:SOLUTION /p:Configuration=Release

      - name: Find test dlls
        shell: pwsh
        run: |
          $dlls = Get-ChildItem -Path "$env:SOLUTION_DIR\*\bin\*" -Filter "*test*.dll" -Recurse -Force | 
                  Where-Object {
                    $_.FullName -notmatch '\\obj\\' -and
                    $_.Name -notlike '*TestAdapter.dll' -and
                    $_.Name -notlike 'Microsoft.TestPlatform*.dll' -and
                    $_.Name -notlike 'Microsoft.VisualStudio*.dll' -and
                    $_.Name -ne 'Civica.Central.TestAutomation.Framework.dll' -and
                    $_.Name -ne 'TechTalk.SpecFlow.MSTest.SpecFlowPlugin.dll'
                  } |
                  ForEach-Object { $_.FullName }
          Write-Host "$($dlls.Count) test dlls found"

          # write out as a serialised string serialize (GitHub Actions environment variables only support strings)
          echo "TEST_DLLS=$($dlls -join ';')" >> $env:GITHUB_ENV

      - name: Update dll.confing files
        shell: pwsh
        run: | 
          . "$env:SOLUTION_DIR/functions.ps1"
        
          # Get dlls array (GitHub Actions environment variables only support strings)
          $testDlls = $env:TEST_DLLS -split ';'	
          if ($testDlls -eq $null -or $testDlls.Count -le 0) {
            Write-Host "No test dlls found"
          }  
          else {
            Write-Host "$($testDlls.Count) test dlls found"
            foreach($dll in $testDlls) {
            
              $configFile = "$dll.config"
              # Check if the config file exists
              if (Test-Path $configFile) {
                Write-Host "Updating config file $configFile with appSettings from: vars.SETTINGS_BASE64_INVOLVE_TESTING_SELENIUM"
                Update-AppConfigXmlAppSettings $configFile "${{ vars.SETTINGS_BASE64_INVOLVE_TESTING_SELENIUM }}"
              } else {
                Write-Host "Config file $configFile doesn't exist"
              }
            }
          }     

      - name: Locate vstest.console.exe
        shell: pwsh
        run: |
          $path = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" `
            -latest -products * `
            -requires Microsoft.VisualStudio.PackageGroup.TestTools.Core `
            -find **\CommonExtensions\Microsoft\TestWindow\vstest.console.exe
            
          echo "VSTEST_PATH=$path" >> $env:GITHUB_ENV

      - name: 'Az CLI login'
        if: false
        uses: Azure/login@v2.3.0
        with:
            creds: '{"clientId":"${{ secrets.DEPLOYMENT_AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.DEPLOYMENT_AZURE_CLIENT_SECRET }}","tenantId":"${{ secrets.DEPLOYMENT_AZURE_TENANT_ID }}","subscriptionId":"${{ secrets.DEPLOYMENT_AZURE_SUBSCRIPTION_ID }}"}'
            allow-no-subscriptions: true
          
      - name: Test     
        shell: pwsh
        run: |
          Write-Host "env:VSTEST_PATH: $env:VSTEST_PATH"          

          # Get dlls array (GitHub Actions environment variables only support strings)
          $testDlls = $env:TEST_DLLS -split ';'	
          if ($testDlls -eq $null -or $testDlls.Count -le 0) {
            Write-Host "No test dlls found"
          }  
          else {
            Write-Host "$($testDlls.Count) test dlls found"
            foreach($dll in $testDlls) {
              Write-Host "Running tests for $dll"
              & "$env:VSTEST_PATH" $dll /Logger:trx
            }
          }
          
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/*.trx'
    
